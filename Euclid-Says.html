<html>
    <head>
        <title>Euclid Says - You Discover Math</title>
        <link rel="icon" type="image/x-icon" href="Favicon.png">
        <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/0.5.0-beta4/html2canvas.min.js"></script>
    </head>
    <body style="margin: 0 0;">
        <center>
            <br>
            <h1>Euclid Says</h1>
            <br>
            <span>Assign Problem (1 - 2148): </span><input id="assign" type="number" min="1" max="2148"><br><br><button id="assignBtn" onclick="assign()">Assign!</button>
            <p style="margin: 0% 10%; font-size: 20px;" id="Prompt">If possible draw a (plane) geometric figure and label two angles A and B...</p><br>
            <iframe style="border: 2px black solid;" id="canvas" src="./Desmos.html" width="50%" height="50%"></iframe><br>
            <br>
            <p id="problemNum"></p><br>
            <button class="roll" onclick="roll1()">1 Card!</button>
            <button class="roll" onclick="roll2()">2 Cards!</button>
            <button class="roll" onclick="roll3()">3 Cards!</button><br><br>
            <input id="cb" type="checkbox" onclick="impossible()">
            <label onclick="impossible()">Impossible</label>
            <p>Enter your reasoning:</p>
            <textarea id="text" style="width: 50%; height: 7%; font-family: 'Times New Roman'; font-size: 15px;"></textarea><br>
            <br>
            <button onclick="submit()" id="sub" disabled>Submit!</button>
            <p id="response"></p>
            <button onclick="save()" id="save" disabled>Save!</button><br><br>
            <canvas id="SaveDiagram" width="750" height="750" style="border: 2px black solid;">
            </canvas>
        </center>
        <script>
            var cv = document.getElementById("SaveDiagram");
            var ctx = cv.getContext('2d');
            var prompt = document.getElementById("Prompt");
            var sub = document.getElementById("sub");
            var response = document.getElementById("response");
            var card1 = ["one of which is acute and the other of which is right, ", "one of which is acute and the other of which is obtuse, ","one of which is right and the other of which is obtuse, ","both of which are acute, ","both of which are right, ","both of which are obtuse, "];
            var card2 = ["angle A and angle B are complementary","angle A and angle B are congruent","angle A and angle B are vertical","angle A and angle B are adjacent","angle A and angle B are not complementary","angle A and angle B are supplementary","angle A and angle B are not supplementary","angle A and angle B are congruent and complementary","angle A and angle B are congruent and supplementary","angle A and angle B are complementary and not congruent","angle A and angle B are supplementary and not congruent","angle A and angle B are vertical and complementary","angle A and angle B are vertical and supplementary","angle A and angle B are adjacent and congruent","angle A and angle B are adjacent and complementary","angle A and angle B are adjacent and supplementary","angle A and angle B are neither vertical nor adjacent"];
            var card3 = ["the figure contains another angle, C, which is congruent to angle A.","the figure contains another angle, C, which is not congruent to angle A.","the figure contains another angle, C, which is congruent to angle B.","the figure contains another angle, C, which is not congruent to angle B.","the figure contains another angle, C, which is supplementary to angle A.","the figure contains another angle, C, which is not supplementary to angle A.","the figure contains another angle, C, which is supplementary to angle B.","the figure contains another angle, C, which is not supplementary to angle B.","the figure contains another angle, C, which is complementary to angle A.","the figure contains another angle, C, which is not complementary to angle A.","the figure contains another angle, C, which is complementary to angle B.","the figure contains another angle, C, which is not complementary to angle B.","the figure contains another angle, C, which is vertical to angle A.","the figure contains another angle, C, which is not vertical to angle A.","the figure contains another angle, C, which is vertical to angle B.","the figure contains another angle, C, which is not vertical to angle B.","the figure contains another angle, C, which is adjacent to angle A.","the figure contains another angle, C, which is not adjacent to angle A.","the figure contains another angle, C, which is adjacent to angle B.","the figure contains another angle, C, which is not adjacent to angle B."];
            var cards = ["", "", ""];
            var dict1 = ["both", "acute", "right", "obtuse"];
            var dict2 = ["and", "complementary", "congruent", "vertical", "adjacent", "supplementary"];
            var checkbox = document.getElementById("cb");
            var number = document.getElementById("assign");
            var assignBtn = document.getElementById("assignBtn");
            var problemID = -1;
            var problemNum = document.getElementById("problemNum");
            var saveBtn = document.getElementById("save");
            var textArea = document.getElementById("text");
            function save() {
                // Select the element that you want to capture
                const captureElement = document.getElementById("canvas").contentDocument.querySelectorAll(".dcg-grapher")[1];
                // Call the html2canvas function and pass the element as an argument
                html2canvas(captureElement,{background: "#fff"}).then((canvas) => {
                    // Get the image data as a base64-encoded string
                    
                    ctx.drawImage(canvas, 375 - canvas.width/2, 375 - canvas.height/2);
                    const imageData = cv.toDataURL("image/png");
                    ctx.fillStyle = "#fff";
                    ctx.globalCompositeOperation = 'destination-over'
                    ctx.fillRect(0,0,cv.width,cv.height);

                    // Do something with the image data, such as saving it as a file or sending it to a server
                    // For example, you can create an anchor element and trigger a download action
                    const link = document.createElement("a");
                    link.setAttribute("download", "Problem " + (problemID + 1) + " Solution.png");
                    link.setAttribute("href", imageData);
                    link.click();
                    
                    ctx.clearRect(0, 0,canvas.width, canvas.height);
                    ctx.fillStyle = "#000";
                    ctx.globalCompositeOperation = 'source-over';
                });
            }
            function fragmentText(text, maxWidth) {
                var words = text.split(' '),
                    lines = [],
                    line = "";
                if (ctx.measureText(text).width < maxWidth) {
                    return [text];
                }
                while (words.length > 0) {
                    while (ctx.measureText(words[0]).width >= maxWidth) {
                        var tmp = words[0];
                        words[0] = tmp.slice(0, -1);
                        if (words.length > 1) {
                            words[1] = tmp.slice(-1) + words[1];
                        } else {
                            words.push(tmp.slice(-1));
                        }
                    }
                    if (ctx.measureText(line + words[0]).width < maxWidth) {
                        line += words.shift() + " ";
                    } else {
                        lines.push(line);
                        line = "";
                    }
                    if (words.length === 0) {
                        lines.push(line);
                    }
                }
                return lines;
            }
            function assign() {
                if (number.value == "") {
                    problemNum.innerHTML = "Enter a number between 1 - 2148."
                    return;
                }
                if (problemID == parseInt(number.value-1)) {
                    problemNum.innerHTML = "You just did this problem!";
                    return;
                }
                response.innerHTML = ""; 
                problemID = parseInt(number.value - 1);
                if (problemID < card1.length) {
                    var s1 = card1[problemID];
                    cards[0] = s1;
                    prompt.innerHTML = "If possible draw a (plane) geometric figure and label two angles A and B " + s1.substring(0,s1.length-2) + ".";
                }
                else if (problemID < card1.length + (card1.length - 1)*card2.length + card2.length) {
                    var s1 = card1[Math.floor((problemID - card1.length)/card2.length)];
                    var s2 = card2[(problemID - card1.length)%card2.length];
                    cards[0] = s1;
                    cards[1] = s2;
                    if (s2.indexOf("nor") != -1) {
                        cards[1] = s2.substring(0, s2.indexOf("nor")) + "nand" + s2.substring(s2.indexOf("nor")+3);
                    }
                    prompt.innerHTML = "If possible draw a (plane) geometric figure and label two angles A and B " + s1+ "such that " + s2 + ".";
                }
                else {
                    var s1 = card1[Math.floor((problemID - card1.length*card2.length-card1.length)/(card2.length*card3.length))];
                    var s2 = card2[Math.floor((problemID - card1.length*card2.length-card1.length)/card3.length)%card2.length];
                    var s3 = card3[(problemID - card1.length*card2.length-card1.length)%card3.length];
                    cards[0] = s1;
                    cards[1] = s2;
                    if (s2.indexOf("nor") != -1) {
                        cards[1] = s2.substring(0, s2.indexOf("nor")) + "nand" + s2.substring(s2.indexOf("nor")+3);
                    }
                    cards[2] = s3;
                    prompt.innerHTML = "If possible draw a (plane) geometric figure and label two angles A and B " + s1 + "such that " + s2 + " and such that " + s3;
                }
                sub.disabled = false;
                checkbox.checked = false;
                impossible();
                $(".roll").prop("disabled", true);
                assignBtn.disabled = true;
                problemNum.innerHTML = "Problem ID: " + (problemID + 1);
            }
            function impossible() {
                var iframe = document.getElementById("canvas");
                if (checkbox.checked) {
                    iframe.style.filter = "brightness(50%)";
                    iframe.style.pointerEvents = "none";
                }
                else {
                    iframe.style.filter = "brightness(100%)";
                    iframe.style.pointerEvents = "auto";
                }
            }
            function check(angles, points) {
                var both = false;
                var success1 = "";
                var overall_success = false;
                for (var k = 0; k < dict1.length; k++) {
                    if (cards[0].indexOf(dict1[k]) != -1) {
                        if (k == 0) {
                            both = true;
                        }
                        else if (k == 1) {
                            if (both) {
                                if (parseFloat(angles[points.indexOf("A")]) < 90 && parseFloat(angles[points.indexOf("B")]) < 90) {
                                    success1 = "AB";
                                    break;
                                }
                            } 
                            else {
                                if (success1 == "") {
                                    if (parseFloat(angles[points.indexOf("A")]) < 90) {
                                        success1 = "B";
                                    }
                                    else if (parseFloat(angles[points.indexOf("B")]) < 90) {
                                        success1 = "A";
                                    }
                                }
                                else {
                                    if (parseFloat(angles[points.indexOf(success1)]) < 90) {
                                        success1 = "AB";
                                        break;
                                    }
                                }
                            }
                        }
                        else if (k == 2) {
                            if (both) {
                                if (parseFloat(angles[points.indexOf("A")]) == 90 && parseFloat(angles[points.indexOf("B")]) == 90) {
                                    success1 = "AB";
                                    break;
                                }
                            } 
                            else {
                                if (success1 == "") {
                                    if (parseFloat(angles[points.indexOf("A")]) == 90) {
                                        success1 = "B";
                                    }
                                    else if (parseFloat(angles[points.indexOf("B")]) == 90) {
                                        success1 = "A";
                                    }
                                }
                                else {
                                    if (parseFloat(angles[points.indexOf(success1)]) == 90) {
                                        success1 = "AB";
                                        break;
                                    }
                                }
                            }
                        }
                        else if (k == 3) {
                            if (both) {
                                if (parseFloat(angles[points.indexOf("A")]) > 90 && parseFloat(angles[points.indexOf("B")]) > 90) {
                                    success1 = "AB";
                                    break;
                                }
                            } 
                            else {
                                if (success1 == "") {
                                    if (parseFloat(angles[points.indexOf("A")]) > 90) {
                                        success1 = "B";
                                    }
                                    else if (parseFloat(angles[points.indexOf("B")]) > 90) {
                                        success1 = "A";
                                    }
                                }
                                else {
                                    if (parseFloat(angles[points.indexOf(success1)]) > 90) {
                                        success1 = "AB";
                                        break;
                                    }
                                }
                            }
                        }
                    }
                }
                if (success1 == "AB") {
                    overall_success = true;
                }
                if (cards[1] != "" && overall_success) {
                    overall_success = false;
                    var success2 = true;
                    var and = [];
                    var and_value = -1;
                    var and_condition = true;
                    for (var k = 0; k < dict2.length; k++) {
                        if (cards[1].indexOf(dict2[k], 15) != -1) {
                            if (k == 0) {
                                if (cards[1][cards[1].indexOf("and") - 1] != "n") {
                                    var conditions = [cards[1].substring(24, cards[1].indexOf("and", 15)-1), cards[1].substring(cards[1].indexOf("and", 15) + 4)];
                                    for (var i = 0; i < 2; i++) {
                                        if (conditions[i].indexOf("not") != -1) {
                                            and.push([dict2.indexOf(conditions[i].substring(4)), false]);
                                            continue;
                                        }
                                        and.push([dict2.indexOf(conditions[i]), true]);
                                    }
                                }
                                else {
                                    var conditions = [cards[1].substring(31, cards[1].indexOf("and", 15)-2), cards[1].substring(cards[1].indexOf("and", 15) + 4)];
                                    and.push([dict2.indexOf(conditions[0]), false]);
                                    and.push([dict2.indexOf(conditions[1]), false]);
                                }
                                and_value = 0;
                            }
                            if (k == 1 || (and_value >= 0 && and[and_value][0] == 1)) {
                                if (and_value < 0) {
                                    if (cards[1].indexOf("not " + dict2[k]) != -1) {
                                        success2 = (parseFloat(angles[points.indexOf("A")]) + parseFloat(angles[points.indexOf("A")]) == 90);
                                    }
                                    else {
                                        success2 = (parseFloat(angles[points.indexOf("A")]) + parseFloat(angles[points.indexOf("A")]) == 90);
                                    }
                                    break;
                                }
                                else {
                                    and_condition = and_condition && ((parseFloat(angles[points.indexOf("A")]) + parseFloat(angles[points.indexOf("A")]) == 90) == and[and_value][1]);
                                    and_value += 1;
                                    if (and_value == 2) {
                                        success2 = and_condition;
                                        break;
                                    }
                                }
                            }
                            if (k == 2 || (and_value >= 0 && and[and_value][0] == 2)) {
                                if (and_value < 0) {
                                    if (cards[1].indexOf("not " + dict2[k]) != -1) {
                                        success2 = (parseFloat(angles[points.indexOf("A")]) != parseFloat(angles[points.indexOf("A")]));
                                    }
                                    else {
                                        success2 = (parseFloat(angles[points.indexOf("A")]) == parseFloat(angles[points.indexOf("A")]));
                                    }
                                    break;
                                }
                                else {
                                    and_condition = and_condition && ((parseFloat(angles[points.indexOf("A")]) == parseFloat(angles[points.indexOf("A")])) == and[and_value][1]);
                                    and_value += 1;
                                    if (and_value == 2) {
                                        success2 = and_condition;
                                        break;
                                    }
                                }
                            }
                            if (k == 4 || (and_value >= 0 && and[and_value][0] == 4)) {
                                if (and_value < 0) {
                                    if (cards[1].indexOf("not " + dict2[k]) != -1) {
                                        success2 = (Math.abs(points.indexOf("A") - points.indexOf("B")) != 1 && Math.abs(points.indexOf("A") - points.indexOf("B")) != points.length - 1) ;
                                    }
                                    else {
                                        success2 = (Math.abs(points.indexOf("A") - points.indexOf("B")) == 1 || Math.abs(points.indexOf("A") - points.indexOf("B")) == points.length - 1) ;
                                    }
                                    break;
                                }
                                else {
                                    and_condition = and_condition && ((Math.abs(points.indexOf("A") - points.indexOf("B")) == 1 || Math.abs(points.indexOf("A") - points.indexOf("B")) == points.length - 1) == and[and_value][1]);
                                    and_value += 1;
                                    if (and_value == 2) {
                                        success2 = and_condition;
                                        break;
                                    }
                                }
                            }
                            if (k == 5 || (and_value >= 0 && and[and_value][0] == 5)) {
                                if (and_value < 0) {
                                    if (cards[1].indexOf("not " + dict2[k]) != -1) {
                                        success2 = (parseFloat(angles[points.indexOf("A")]) + parseFloat(angles[points.indexOf("A")]) != 180);
                                    }
                                    else {
                                        success2 = (parseFloat(angles[points.indexOf("A")]) + parseFloat(angles[points.indexOf("A")]) == 180);
                                    }
                                    break;
                                }
                                else {
                                    and_condition = and_condition && ((parseFloat(angles[points.indexOf("A")]) + parseFloat(angles[points.indexOf("A")]) == 180) == and[and_value][1]);
                                    and_value += 1;
                                    if (and_value == 2) {
                                        success2 = and_condition;
                                        break;
                                    }
                                }
                            }
                        }
                    }
                    if (success2) {
                        overall_success = true;
                    }
                    if (cards[2] != "" && overall_success) {
                        overall_success = false;
                        var success3 = "";
                    }
                }
                return overall_success;
            }
            function roll1() {
                response.innerHTML = "";
                var s1 = card1[Math.floor(Math.random()*card1.length)];
                problemID = card1.indexOf(s1);
                cards[0] = s1;
                prompt.innerHTML = "If possible draw a (plane) geometric figure and label two angles A and B " + s1.substring(0,s1.length-2) + ".";
                sub.disabled = false;
                checkbox.checked = false;
                impossible();
                $(".roll").prop("disabled", true);
                problemNum.innerHTML = "Problem ID: " + (problemID + 1);
                assignBtn.disabled = true;
                saveBtn.disabled - true;
            }
            function roll2() {
                response.innerHTML = "";
                var s1 = card1[Math.floor(Math.random()*card1.length)];
                var s2 = card2[Math.floor(Math.random()*card2.length)];
                cards[0] = s1;
                cards[1] = s2;
                problemID = card1.length + card1.indexOf(s1)*card2.length + card2.indexOf(s2);
                if (s2.indexOf("nor") != -1) {
                    cards[1] = s2.substring(0, s2.indexOf("nor")) + "nand" + s2.substring(s2.indexOf("nor")+3);
                }
                prompt.innerHTML = "If possible draw a (plane) geometric figure and label two angles A and B " + s1+ "such that " + s2 + ".";
                sub.disabled = false;
                checkbox.checked = false;
                impossible();
                $(".roll").prop("disabled", true);
                problemNum.innerHTML = "Problem ID: " + (problemID + 1);
                assignBtn.disabled = true;
                saveBtn.disabled - true;
            }
            function roll3() {
                response.innerHTML = "";
                var s1 = card1[Math.floor(Math.random()*card1.length)];
                var s2 = card2[Math.floor(Math.random()*card2.length)];
                var s3 = card3[Math.floor(Math.random()*card3.length)];
                cards[0] = s1;
                cards[1] = s2;
                problemID = card1.length + card1.length*card2.length + card1.indexOf(s1)*card2.length*card3.length + card2.indexOf(s2)*card3.length + card3.indexOf(s3);
                if (s2.indexOf("nor") != -1) {
                    cards[1] = s2.substring(0, s2.indexOf("nor")) + "nand" + s2.substring(s2.indexOf("nor")+3);
                }
                cards[2] = s3;
                prompt.innerHTML = "If possible draw a (plane) geometric figure and label two angles A and B " + s1 + "such that " + s2 + " and such that " + s3;
                sub.disabled = false;
                checkbox.checked = false;
                impossible();
                $(".roll").prop("disabled", true);
                problemNum.innerHTML = "Problem ID: " + (problemID + 1);
                assignBtn.disabled = true;
                saveBtn.disabled - true;
            }
            function submit() {
                var canvas = document.getElementById("canvas").contentDocument;
                var text = canvas.querySelectorAll(".dcg-label-raw-text");
                var labels = []
                for (var i = 0; i < text.length; i++) {
                    labels.push(text[i].innerHTML);
                }
                var points = [];
                var angles = [];
                for (var j = 0; j < labels.length; j++) {
                    if (labels[j].indexOf("°") == -1) {
                        points.push(labels[j]);
                        continue;
                    }
                    angles.push(labels[j])
                }
                
                if (check(angles, points)) {
                    response.innerHTML = "Great job!";
                }
                else {
                    response.innerHTML = "Oops! That's not correct. Try another one!";
                }
                cards = ["", "", ""];
                $(".roll").prop("disabled", false);
                assignBtn.disabled = false;
                saveBtn.disabled = false;
                sub.disabled = true;
                ctx.font = "30px Arial";
                ctx.textAlign = "center";
                var lines = fragmentText(prompt.innerHTML, 750 - parseInt(30,0));
                lines.forEach(function(line, i) {
                    ctx.fillText(line, 750 / 2, (i + 1) * parseInt(30,0));
                });
                var lines = fragmentText(textArea.value, 750 - parseInt(30,0));
                lines.forEach(function(line, i) {
                    ctx.fillText(line, 750 / 2, (i + 23) * parseInt(30,0));
                });
            }
        </script>
    </body>
</html>